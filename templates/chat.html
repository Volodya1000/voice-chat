{% extends "base.html" %}
{% block title %}–ß–∞—Ç—ã{% endblock %}

{% block body %}
<div class="layout">
  {% include 'partials/sidebar.html' %}
  <main class="chat-area">
    {% if selected_chat %}
      {% include 'partials/messages.html' %}

      <form id="send-form" class="send-form">
        <input name="content" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required />
        <button type="button" id="voice-record-button" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ (–°–µ—Ä–≤–µ—Ä–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è)">
          <span id="voice-icon">üé§</span>
        </button>
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>

      <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ -->
      <button id="toggle-tts-panel" class="toggle-btn">üéß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∑–≤—É—á–∫–∏</button>

      <!-- –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è –ø–∞–Ω–µ–ª—å -->
      <section id="tts-settings" class="tts-settings hidden">
        <h3>üéß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∑–≤—É—á–∫–∏</h3>

        <!-- –í—ã–±–æ—Ä –¥–∏–∫—Ç–æ—Ä–∞ -->
        <label for="voice-select">–ì–æ–ª–æ—Å:</label>
        <select id="voice-select" name="speaker">
          {% set default_speakers = ['aidar', 'baya', 'kseniya', 'xenia', 'eugene', 'random'] %}
          {% for speaker in available_speakers or default_speakers %}
            <option value="{{ speaker }}">{{ speaker }}</option>
          {% endfor %}
        </select>

        <!-- –°–∫–æ—Ä–æ—Å—Ç—å -->
        <div class="slider-group">
          <!-- –ò–∑–º–µ–Ω–∏–ª span id –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π input id + '-value' -->
          <label for="speed-range">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="speed-range-value">1.0</span>x</label>
          <input type="range" id="speed-range" name="speed" min="0.2" max="3.0" value="1.0" step="0.1">
        </div>

        <!-- –í—ã—Å–æ—Ç–∞ —Ç–æ–Ω–∞ -->
        <div class="slider-group">
          <label for="pitch-range">–í—ã—Å–æ—Ç–∞ —Ç–æ–Ω–∞ (–ø–æ–ª—É—Ç–æ–Ω–∞): <span id="pitch-range-value">0</span></label>
          <input type="range" id="pitch-range" name="pitch" min="-12" max="12" value="0" step="1">
        </div>

        <!-- –ì—Ä–æ–º–∫–æ—Å—Ç—å -->
        <div class="slider-group">
          <label for="gain-range">–ì—Ä–æ–º–∫–æ—Å—Ç—å (–¥–ë): <span id="gain-range-value">0</span></label>
          <input type="range" id="gain-range" name="gain_db" min="-30" max="10" value="0" step="1">
        </div>

        <!-- –†–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—è -->
        <div class="slider-group">
          <label for="reverb-time">–†–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—è (—Å–µ–∫): <span id="reverb-time-value">0.0</span></label>
          <input type="range" id="reverb-time" name="reverb_time" min="0" max="5" step="0.1" value="0">

          <label for="reverb-decay">–ó–∞—Ç—É—Ö–∞–Ω–∏–µ (0..1): <span id="reverb-decay-value">0.00</span></label>
          <input type="range" id="reverb-decay" name="reverb_decay" min="0" max="1" step="0.05" value="0">
        </div>

        <!-- –£–±—Ä–∞–Ω—ã –ø–∞—É–∑—ã silence_before/silence_after –ø–æ –∑–∞–ø—Ä–æ—Å—É -->

        <button id="tts-button" type="button">‚ñ∂Ô∏è –û–∑–≤—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
        <button id="play-audio-button" type="button">üîä –ü—Ä–æ—Å–ª—É—à–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∞—É–¥–∏–æ</button>
      </section>
    {% else %}
      <div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.</div>
    {% endif %}
  </main>
</div>

{% include 'partials/loading_indicator.html' %}

<script>
  // –¢–æ–≥–≥–ª –ø–∞–Ω–µ–ª–∏
  const ttsPanel = document.getElementById('tts-settings');
  const toggleBtn = document.getElementById('toggle-tts-panel');
  toggleBtn.addEventListener('click', () => {
    ttsPanel.classList.toggle('hidden');
    toggleBtn.textContent = ttsPanel.classList.contains('hidden')
      ? "üéß –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∑–≤—É—á–∫–∏"
      : "üîΩ –°–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∑–≤—É—á–∫–∏";
  });

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –ø–æ–∫–∞–∑–∞
  function formatLabelFor(slider, value) {
    if (!value && value !== 0) value = slider.value;
    switch (slider.id) {
      case 'speed-range':
        return parseFloat(value).toFixed(1);
      case 'pitch-range':
        return parseInt(value, 10).toString();
      case 'gain-range': {
        const v = parseInt(value, 10);
        return (v > 0 ? '+' + v : v.toString());
      }
      case 'reverb-time':
        return parseFloat(value).toFixed(1);
      case 'reverb-decay':
        return parseFloat(value).toFixed(2);
      default:
        return value;
    }
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∏—Å–µ–ª –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –ø–æ–ª–∑—É–Ω–∫–æ–≤ (robust)
  document.querySelectorAll('input[type="range"]').forEach(slider => {
    // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —è—Ä–ª—ã–∫ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º
    let label = document.getElementById(slider.id + '-value');
    if (!label) {
      // –∏–Ω–æ–≥–¥–∞ input id –º–æ–∂–µ—Ç –±—ã—Ç—å —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º -range, –ø–æ–ø—Ä–æ–±—É–µ–º —É–±—Ä–∞—Ç—å
      const alt = slider.id.replace(/-range$/, '');
      label = document.getElementById(alt + '-value') || document.getElementById(slider.id.replace(/-time$/, '') + '-value');
    }
    // –ü—Ä–∏—Å–≤–æ–∏–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–∞—à–ª–∏ label
    if (label) {
      label.textContent = formatLabelFor(slider, slider.value);
      slider.addEventListener('input', () => {
        label.textContent = formatLabelFor(slider, slider.value);
      });
    } else {
      // Fallback: –µ—Å–ª–∏ label –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º (–Ω–µ –ª–æ–º–∞–µ—Ç —Ä–∞–±–æ—Ç—É)
      slider.addEventListener('input', () => {
        // –Ω–∏—á–µ–≥–æ
      });
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ TTS
  let lastAudioUrl = null;
  document.getElementById('tts-button').addEventListener('click', async () => {
    const text = document.getElementById('message-input').value.trim();
    if (!text) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏.");

    const payload = {
      text,
      speaker: document.getElementById('voice-select').value,
      speed: parseFloat(document.getElementById('speed-range').value),
      pitch_semitones: parseInt(document.getElementById('pitch-range').value, 10),
      gain_db: parseFloat(document.getElementById('gain-range').value),
      reverb_time: parseFloat(document.getElementById('reverb-time').value),
      reverb_decay: parseFloat(document.getElementById('reverb-decay').value)
      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—É–∑ —É–¥–∞–ª–µ–Ω—ã (—É–±—Ä–∞–Ω—ã –ø–∞—É–∑—ã –¥–æ/–ø–æ—Å–ª–µ)
    };

    try {
      const resp = await fetch("/tts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        alert("–û—à–∏–±–∫–∞ TTS: " + resp.statusText);
        return;
      }

      const blob = await resp.blob();
      if (lastAudioUrl) {
        // –æ—á–∏—Å—Ç–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—ä–µ–∫—Ç
        URL.revokeObjectURL(lastAudioUrl);
        lastAudioUrl = null;
      }
      const url = URL.createObjectURL(blob);
      lastAudioUrl = url;

      const audio = new Audio(url);
      audio.play();
      audio.addEventListener('ended', () => {
        // –º–æ–∂–Ω–æ –æ—Ç–∑—ã–≤–∞—Ç—å url —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è
        // –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º lastAudioUrl —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ "–ü—Ä–æ—Å–ª—É—à–∞—Ç—å" —Ä–∞–±–æ—Ç–∞–ª–∞,
        // –∏ –æ—Ç–∑–æ–≤—ë–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π url –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ
      });
    } catch (err) {
      console.error(err);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ TTS.");
    }
  });

  // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∞—É–¥–∏–æ
  document.getElementById('play-audio-button').addEventListener('click', () => {
    if (!lastAudioUrl) return alert("–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ ¬´–û–∑–≤—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç¬ª.");
    const audio = new Audio(lastAudioUrl);
    audio.play();
  });
</script>

<style>
  .toggle-btn {
    margin-top: 0.5rem;
    padding: 0.5rem 1rem;
    background: #222;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  .toggle-btn:hover {
    background: #333;
  }

  .tts-settings {
    margin-top: 0.5rem;
    padding: 1rem;
    border: 1px solid #444;
    border-radius: 10px;
    background: #1a1a1a;
    color: #f5f5f5;
  }

  .tts-settings.hidden {
    display: none;
  }

  .slider-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
  }

  label {
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
  }

  input[type="range"] {
    width: 100%;
  }

  #tts-button, #play-audio-button {
    margin-top: 0.5rem;
    margin-right: 0.5rem;
  }
</style>
{% endblock %}
