{% extends "base.html" %}
{% block title %}–ß–∞—Ç—ã{% endblock %}

{% block body %}
<style>
    /* -------------------------------------- */
    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –æ–±—â–µ–≥–æ –º–∞–∫–µ—Ç–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    /* -------------------------------------- */
    .layout {
        display: flex;
        height: 100vh;
        max-height: 100vh;
    }

    .sidebar {
        width: 250px;
        background-color: #f8f9fa;
        padding: 20px;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
    }

    .chat-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background-color: #fff;
        position: relative;
    }

    .messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .empty {
        text-align: center;
        padding: 50px;
        color: #6c757d;
        font-size: 1.2em;
    }

    /* -------------------------------------- */
    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π */
    /* -------------------------------------- */
    .message {
        padding: 10px 15px;
        margin-bottom: 15px;
        border-radius: 10px;
        max-width: 70%;
        word-wrap: break-word;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .message.USER {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 0;
    }

    .message.MODEL {
        background-color: #e9ecef;
        color: #212529;
        margin-right: auto;
        border-bottom-left-radius: 0;
    }

    .message.MODEL.streaming {
        border-left: 3px solid #007bff;
        opacity: 0.8;
    }

    .m-meta {
        font-size: 0.75em;
        color: rgba(255, 255, 255, 0.7); /* –î–ª—è USER */
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
    }
    .message.MODEL .m-meta {
        color: #6c757d; /* –î–ª—è MODEL */
    }


    /* -------------------------------------- */
    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ */
    /* -------------------------------------- */
    .send-form {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #fff;
        border-top: 1px solid #ddd;
    }
    .send-form input {
        flex-grow: 1;
        margin-right: 10px;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 20px;
        font-size: 16px;
    }
    .send-form button[type="submit"] {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .send-form button[type="submit"]:hover {
        background-color: #0056b3;
    }

    #voice-record-button {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 50%;
        cursor: pointer;
        width: 44px;
        height: 44px;
        font-size: 20px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s, color 0.2s;
        margin-right: 10px;
    }
    #voice-record-button:hover {
        background-color: #e2e6ea;
    }
    #voice-record-button.recording {
        color: white;
        background-color: #dc3545; /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ */
        animation: pulse 1.5s infinite;
    }
    #voice-record-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }

    .loading-indicator {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        z-index: 1000;
        pointer-events: none; /* –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ */
    }
</style>

<div class="layout">
    <aside class="sidebar">
        <h3>–ß–∞—Ç—ã</h3>
        <ul class="chat-list">
            {% for c in chats %}
                <li class="chat-item {% if selected_chat and c.id == selected_chat %}active{% endif %}">
                    <a href="/chats/{{ c.id }}">{{ c.title }}</a>
                    <div class="meta">{{ c.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</div>
                </li>
            {% endfor %}
        </ul>

        <form method="post" action="/chats/new" class="new-chat-form">
            <input name="title" placeholder="–ù–æ–≤—ã–π —á–∞—Ç" required/>
            <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
        </form>

        <a href="/logout">–í—ã–π—Ç–∏</a>
    </aside>

    <main class="chat-area">
        {% if selected_chat %}
            <div class="messages" id="message-list">
                {% for m in messages %}
                <div class="message {{ m.message_type.value }}" data-id="{{ m.id }}">
                    <div class="m-meta">
                        <strong>{{ m.message_type.value }}</strong>
                        <span class="time">{{ m.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</span>
                    </div>
                    <div class="m-body">{{ m.content }}</div>
                </div>
                {% endfor %}
            </div>

            <form id="send-form" class="send-form">
                <input name="content" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required/>
                <button type="button" id="voice-record-button" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ (–°–µ—Ä–≤–µ—Ä–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è)">
                    <span id="voice-icon">üé§</span>
                </button>
                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        {% else %}
            <div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.</div>
        {% endif %}
    </main>
</div>
<div class="loading-indicator" id="loading-indicator">
    <span id="loading-text">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª—å—é...</span>
</div>

{% if selected_chat %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const messageList = document.getElementById("message-list");
    const sendForm = document.getElementById("send-form");
    const messageInput = document.getElementById("message-input");
    const recordButton = document.getElementById('voice-record-button');
    const voiceIcon = document.getElementById('voice-icon');
    const loadingIndicator = document.getElementById('loading-indicator');
    const loadingText = document.getElementById('loading-text');
    const selectedChatId = {{ selected_chat }};

    function scrollToBottom() {
        if (messageList) {
            messageList.scrollTop = messageList.scrollHeight;
        }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è SSE –∏ DOM ---
    function addMessageToDOM(message) {
        const time = new Date(message.created_at).toLocaleString();
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", message.message_type);
        messageDiv.setAttribute("data-id", message.id);

        messageDiv.innerHTML = `
            <div class="m-meta">
                <strong>${message.message_type}</strong>
                <span class="time">${time}</span>
            </div>
            <div class="m-body">${message.content}</div>
        `;

        if (message.message_type === 'MODEL' && message.content === "") {
            messageDiv.classList.add("streaming");
        }

        messageList.appendChild(messageDiv);
        scrollToBottom();
    }

    function appendTokenToMessage(msgId, token) {
        const messageBody = document.querySelector(`.message[data-id='${msgId}'] .m-body`);
        if (messageBody) {
            messageBody.parentElement.classList.remove("streaming");
            messageBody.innerText += token;
            scrollToBottom();
        }
    }
    // --- –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è SSE –∏ DOM ---


    // --- –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ---
    sendForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content) return;

        const originalContent = content;
        messageInput.value = "";

        try {
            const response = await fetch(`/chats/${selectedChatId}/send`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ content })
            });

            if (!response.ok) {
                console.error("Failed to send message", await response.json());
                messageInput.value = originalContent;
            }
        } catch (error) {
            console.error("Error sending message:", error);
            messageInput.value = originalContent;
        }
    });

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EventSource –¥–ª—è SSE ---
    const eventSource = new EventSource(`/chats/${selectedChatId}/events`);

    eventSource.addEventListener("new_message", (event) => {
        const message = JSON.parse(event.data);
        addMessageToDOM(message);
    });

    eventSource.addEventListener("stream_token", (event) => {
        const tokenData = JSON.parse(event.data);
        appendTokenToMessage(tokenData.msg_id, tokenData.token);
    });

    eventSource.onerror = (error) => {
        console.error("SSE Error:", error);
        eventSource.close();
    };

    scrollToBottom();


    // ------------------------------------------------------------------
    // –õ–û–ì–ò–ö–ê –ì–û–õ–û–°–û–í–û–ì–û –í–í–û–î–ê (MediaRecorder + Backend STT)
    // ------------------------------------------------------------------

    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ MediaRecorder
    const setupRecorder = async () => {
        try {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º MediaRecorder
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'audio/webm' –∏–ª–∏ 'audio/ogg' –¥–ª—è —à–∏—Ä–æ–∫–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –±—Ä–∞—É–∑–µ—Ä–∞–º–∏
            const options = { mimeType: 'audio/webm' };
            mediaRecorder = new MediaRecorder(stream, options);

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = uploadAudio;

            recordButton.disabled = false;
        } catch (err) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ', err);
            recordButton.disabled = true;
            recordButton.title = "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.";
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.");
        }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∫–æ—Ä–¥–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setupRecorder();

    // 2. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
    const uploadAudio = async () => {
        if (audioChunks.length === 0) return;

        const audioBlob = new Blob(audioChunks, { 'type': mediaRecorder.mimeType });
        audioChunks = []; // –û—á–∏—â–∞–µ–º —á–∞–Ω–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–ø–∏—Å–∏

        loadingText.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª—å—é...';
        loadingIndicator.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        recordButton.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

        const formData = new FormData();
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'audio_file' –∫–∞–∫ –∏–º—è –ø–æ–ª—è, –æ–∂–∏–¥–∞–µ–º–æ–µ –±—ç–∫–µ–Ω–¥–æ–º
        formData.append("audio_file", audioBlob, "recording." + mediaRecorder.mimeType.split('/')[1]);

        try {
            const response = await fetch(`/chats/transcribe_voice`, {
                method: "POST",
                body: formData
            });

            loadingIndicator.style.display = 'none';

            if (response.ok) {
                const data = await response.json();
                const transcription = data.content;

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                let currentText = messageInput.value.trim();
                if (currentText.length > 0 && transcription.length > 0) {
                    currentText += ' ';
                } else if (currentText.length === 0 && transcription.length === 0) {
                    // –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –ø—É—Å—Ç–∞, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                    return;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏ –ø—Ä–æ–±–µ–ª –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–≤–æ–¥–∞
                messageInput.value = currentText + transcription + ' ';
                messageInput.focus();

            } else {
                const error = await response.json();
                alert(`–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏: ${error.detail || response.statusText}`);
            }
        } catch (error) {
            loadingIndicator.style.display = 'none';
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞—É–¥–∏–æ:", error);
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞—É–¥–∏–æ.");
        } finally {
            recordButton.disabled = false;
        }
    };

    // 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
    recordButton.addEventListener('click', () => {
        if (!mediaRecorder || recordButton.disabled) return;

        if (isRecording) {
            // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
            mediaRecorder.stop();
            recordButton.classList.remove('recording');
            voiceIcon.textContent = '‚öôÔ∏è'; // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
            isRecording = false;
            // –§—É–Ω–∫—Ü–∏—è uploadAudio –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ mediaRecorder.onstop
        } else {
            // –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
            audioChunks = []; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            mediaRecorder.start();
            recordButton.classList.add('recording');
            voiceIcon.textContent = 'üî¥'; // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
            isRecording = true;
        }
    });

    // ------------------------------------------------------------------
});
</script>
{% endif %}
{% endblock %}