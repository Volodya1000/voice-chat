{% extends "base.html" %}
{% block title %}Чаты{% endblock %}

{% block body %}
<div class="layout">
    <aside class="sidebar">
        <h3>Чаты</h3>
        <ul class="chat-list">
            {% for c in chats %}
                <li class="chat-item {% if selected_chat and c.id == selected_chat %}active{% endif %}">
                    <a href="/chats/{{ c.id }}">{{ c.title }}</a>
                    <div class="meta">{{ c.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</div>
                </li>
            {% endfor %}
        </ul>

        <form method="post" action="/chats/new" class="new-chat-form">
            <input name="title" placeholder="Новый чат" required/>
            <button type="submit">Создать</button>
        </form>

        <a href="/logout">Выйти</a>
    </aside>

    <main class="chat-area">
        {% if selected_chat %}
            <div class="messages" id="message-list">
                {% for m in messages %}
                <div class="message {{ m.message_type.value }}" data-id="{{ m.id }}">
                    <div class="m-meta">
                        <strong>{{ m.message_type.value }}</strong>
                        <span class="time">{{ m.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</span>
                    </div>
                    <div class="m-body">{{ m.content }}</div>
                </div>
                {% endfor %}
            </div>

            <form id="send-form" class="send-form">
                <input name="content" id="message-input" placeholder="Введите сообщение..." required/>
                <button type="submit">Отправить</button>
            </form>
        {% else %}
            <div class="empty">Выберите чат слева или создайте новый.</div>
        {% endif %}
    </main>
</div>

{% if selected_chat %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const messageList = document.getElementById("message-list");
    const sendForm = document.getElementById("send-form");
    const messageInput = document.getElementById("message-input");
    const selectedChatId = {{ selected_chat }};

    function scrollToBottom() {
        messageList.scrollTop = messageList.scrollHeight;
    }

    function addMessageToDOM(message) {
        const time = new Date(message.created_at).toLocaleString();
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", message.message_type);
        messageDiv.setAttribute("data-id", message.id);

        messageDiv.innerHTML = `
            <div class="m-meta">
                <strong>${message.message_type}</strong>
                <span class="time">${time}</span>
            </div>
            <div class="m-body">${message.content}</div>
        `;

        if (message.message_type === 'MODEL' && message.content === "") {
            messageDiv.classList.add("streaming");
        }

        messageList.appendChild(messageDiv);
        scrollToBottom();
    }

    function appendTokenToMessage(msgId, token) {
        const messageBody = document.querySelector(`.message[data-id='${msgId}'] .m-body`);
        if (messageBody) {
            messageBody.parentElement.classList.remove("streaming");
            messageBody.innerText += token;
            scrollToBottom();
        }
    }

    sendForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content) return;

        const originalContent = content;
        messageInput.value = "";

        try {
            const response = await fetch(`/chats/${selectedChatId}/send`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ content })
            });

            if (!response.ok) {
                console.error("Failed to send message", await response.json());
                messageInput.value = originalContent;
            }
        } catch (error) {
            console.error("Error sending message:", error);
            messageInput.value = originalContent;
        }
    });

    const eventSource = new EventSource(`/chats/${selectedChatId}/events`);

    eventSource.addEventListener("new_message", (event) => {
        const message = JSON.parse(event.data);
        addMessageToDOM(message);
    });

    eventSource.addEventListener("stream_token", (event) => {
        const tokenData = JSON.parse(event.data);
        appendTokenToMessage(tokenData.msg_id, tokenData.token);
    });

    eventSource.onerror = (error) => {
        console.error("SSE Error:", error);
        eventSource.close();
    };

    scrollToBottom();
});
</script>
{% endif %}
{% endblock %}
