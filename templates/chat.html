{% extends "base.html" %}
{% block title %}–ß–∞—Ç—ã{% endblock %}

{% block body %}
<style>
    /* -------------------------------------- */
    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ */
    /* -------------------------------------- */
    .send-form {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #fff;
        border-top: 1px solid #ddd;
    }
    .send-form input {
        flex-grow: 1;
        margin-right: 10px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
    }
    .send-form button[type="submit"] {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .send-form button[type="submit"]:hover {
        background-color: #0056b3;
    }

    #voice-record-button {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 5px;
        cursor: pointer;
        padding: 8px 12px;
        font-size: 18px;
        line-height: 1;
        transition: background-color 0.2s, color 0.2s;
        margin-right: 10px;
    }
    #voice-record-button:hover {
        background-color: #e2e6ea;
    }
    #voice-record-button.recording {
        color: white;
        background-color: #dc3545; /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ */
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
    /* –î–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∞—à–∏ —Å—Ç–∏–ª–∏ –¥–ª—è layout, sidebar, chat-area, message –∏ —Ç.–¥. */
    /* –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ—Ä—ã —Å—Ç–∏–ª–µ–π –¥–ª—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ */
</style>

<div class="layout">
    <aside class="sidebar">
        <h3>–ß–∞—Ç—ã</h3>
        <ul class="chat-list">
            {% for c in chats %}
                <li class="chat-item {% if selected_chat and c.id == selected_chat %}active{% endif %}">
                    <a href="/chats/{{ c.id }}">{{ c.title }}</a>
                    <div class="meta">{{ c.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</div>
                </li>
            {% endfor %}
        </ul>

        <form method="post" action="/chats/new" class="new-chat-form">
            <input name="title" placeholder="–ù–æ–≤—ã–π —á–∞—Ç" required/>
            <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
        </form>

        <a href="/logout">–í—ã–π—Ç–∏</a>
    </aside>

    <main class="chat-area">
        {% if selected_chat %}
            <div class="messages" id="message-list">
                {% for m in messages %}
                <div class="message {{ m.message_type.value }}" data-id="{{ m.id }}">
                    <div class="m-meta">
                        <strong>{{ m.message_type.value }}</strong>
                        <span class="time">{{ m.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</span>
                    </div>
                    <div class="m-body">{{ m.content }}</div>
                </div>
                {% endfor %}
            </div>

            <form id="send-form" class="send-form">
                <input name="content" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required/>
                <button type="button" id="voice-record-button" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ (Web Speech API)">
                    <span id="voice-icon">üé§</span>
                </button>
                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        {% else %}
            <div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.</div>
        {% endif %}
    </main>
</div>

{% if selected_chat %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const messageList = document.getElementById("message-list");
    const sendForm = document.getElementById("send-form");
    const messageInput = document.getElementById("message-input");
    const selectedChatId = {{ selected_chat }};

    function scrollToBottom() {
        if (messageList) {
            messageList.scrollTop = messageList.scrollHeight;
        }
    }

    function addMessageToDOM(message) {
        const time = new Date(message.created_at).toLocaleString();
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", message.message_type);
        messageDiv.setAttribute("data-id", message.id);

        messageDiv.innerHTML = `
            <div class="m-meta">
                <strong>${message.message_type}</strong>
                <span class="time">${time}</span>
            </div>
            <div class="m-body">${message.content}</div>
        `;

        if (message.message_type === 'MODEL' && message.content === "") {
            messageDiv.classList.add("streaming");
        }

        messageList.appendChild(messageDiv);
        scrollToBottom();
    }

    function appendTokenToMessage(msgId, token) {
        const messageBody = document.querySelector(`.message[data-id='${msgId}'] .m-body`);
        if (messageBody) {
            messageBody.parentElement.classList.remove("streaming");
            messageBody.innerText += token;
            scrollToBottom();
        }
    }

    sendForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content) return;

        const originalContent = content;
        messageInput.value = "";

        try {
            const response = await fetch(`/chats/${selectedChatId}/send`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ content })
            });

            if (!response.ok) {
                console.error("Failed to send message", await response.json());
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ, –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
                messageInput.value = originalContent;
            }
        } catch (error) {
            console.error("Error sending message:", error);
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏
            messageInput.value = originalContent;
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EventSource –¥–ª—è SSE
    const eventSource = new EventSource(`/chats/${selectedChatId}/events`);

    eventSource.addEventListener("new_message", (event) => {
        const message = JSON.parse(event.data);
        addMessageToDOM(message);
    });

    eventSource.addEventListener("stream_token", (event) => {
        const tokenData = JSON.parse(event.data);
        appendTokenToMessage(tokenData.msg_id, tokenData.token);
    });

    eventSource.onerror = (error) => {
        console.error("SSE Error:", error);
        eventSource.close();
    };

    scrollToBottom();

    // ------------------------------------------------------------------
    // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ì–û–õ–û–°–û–í–û–ì–û –í–í–û–î–ê (Speech-to-Text)
    // ------------------------------------------------------------------

    const recordButton = document.getElementById('voice-record-button');
    const voiceIcon = document.getElementById('voice-icon');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Speech API
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º window.SpeechRecognition –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω webkit)
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!window.SpeechRecognition) {
        recordButton.disabled = true;
        recordButton.title = "–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.";
        console.warn("Web Speech API not supported.");
    } else {
        const recognition = new window.SpeechRecognition();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ –≤–≤–æ–¥–∞
        recognition.continuous = false; // –û—Ç–∫–ª—é—á–∞–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –ø–∞—É–∑—ã
        recognition.interimResults = false; // –ù–∞–º –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        recognition.lang = 'ru-RU'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫

        let isListening = false;
        let finalTranscript = ''; // –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π

        recordButton.addEventListener('click', () => {
            if (isListening) {
                // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
                recognition.stop();
            } else {
                // –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ (–≤–∫–ª—é—á–∞—è –ø—Ä–æ–±–µ–ª)
                finalTranscript = messageInput.value.trim();
                if (finalTranscript.length > 0) {
                    finalTranscript += ' ';
                }

                recognition.start();
                recordButton.classList.add('recording');
                voiceIcon.textContent = 'üî¥';
                isListening = true;
            }
        });

        recognition.onresult = (event) => {
            let currentTranscript = '';

            // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
                    currentTranscript += event.results[i][0].transcript;
                }
            }

            // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ–ª—è, –¥–æ–±–∞–≤–ª—è—è –Ω–æ–≤—ã–π —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É
            messageInput.value = finalTranscript + currentTranscript;

        };

        recognition.onend = () => {
            // –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            recordButton.classList.remove('recording');
            voiceIcon.textContent = 'üé§';
            isListening = false;

            // –û–±–Ω–æ–≤–ª—è–µ–º finalTranscript –Ω–∞ —Ç–æ, —á—Ç–æ —Å–µ–π—á–∞—Å –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            finalTranscript = messageInput.value.trim();
            if (finalTranscript.length > 0) {
                messageInput.value += ' '; // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–≤–æ–¥–∞
            }

            messageInput.focus();
        };

        recognition.onerror = (event) => {
            console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏: ' + event.error);
            recordButton.classList.remove('recording');
            voiceIcon.textContent = 'üé§';
            isListening = false;
            alert(`–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: ${event.error}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –≤—ã –¥–∞–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä—É.`);
        };
    }
    // ------------------------------------------------------------------
});
</script>
{% endif %}
{% endblock %}