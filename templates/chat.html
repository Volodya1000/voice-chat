{% extends "base.html" %}
{% block title %}–ß–∞—Ç—ã{% endblock %}

{% block body %}
<div class="layout">
  {% include 'partials/sidebar.html' %}
  <main class="chat-area">
    {% if selected_chat %}
      {% include 'partials/messages.html' %}
      <form id="send-form" class="send-form">
        <input name="content" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required/>
        <button type="button" id="voice-record-button" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ (–°–µ—Ä–≤–µ—Ä–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è)">
          <span id="voice-icon">üé§</span>
        </button>
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

        <button id="play-audio-button" type="button">‚ñ∂Ô∏è –ü—Ä–æ—Å–ª—É—à–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–µ –∞—É–¥–∏–æ</button>

        <button id="tts-button" type="button">‚ñ∂Ô∏è –û–∑–≤—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
      </form>

      <script>
      document.addEventListener('DOMContentLoaded', () => {
          // –ò—â–µ–º –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É ID
          const ttsButton = document.getElementById('tts-button');
          // –°—Ç–∞—Ä–∞—è –∫–Ω–æ–ø–∫–∞ (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
          const oldPlayAudioButton = document.getElementById('play-audio-button');
          const messageInput = document.getElementById('message-input');

          // 1. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û–∑–≤—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç" (TTS)
          if (ttsButton && messageInput) {
              ttsButton.addEventListener('click', async () => {
                  const textToSpeak = messageInput.value.trim();

                  if (textToSpeak.length === 0) {
                      alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è!");
                      return;
                  }

                  const formData = new FormData();
                  formData.append('text', textToSpeak);

                  try {
                      // –ó–∞–ø—Ä–æ—Å –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É /tts
                      const response = await fetch('/tts', {
                          method: 'POST',
                          body: formData,
                      });

                      if (!response.ok) {
                          // –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—à–∏–±–∫—É –∫–∞–∫ JSON, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ
                          const errorText = await response.text();
                          let errorMessage = '–û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.';
                          try {
                              const errorJson = JSON.parse(errorText);
                              errorMessage = errorJson.detail || errorMessage;
                          } catch (e) {
                             // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
                          }
                          throw new Error(`–°—Ç–∞—Ç—É—Å ${response.status}: ${errorMessage}`);
                      }

                      const audioBlob = await response.blob();
                      const audioUrl = URL.createObjectURL(audioBlob);
                      const audio = new Audio(audioUrl);

                      audio.play();

                      audio.onended = () => {
                          URL.revokeObjectURL(audioUrl);
                      };

                  } catch (error) {
                      console.error('TTS Error:', error);
                      alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                  }
              });
          }

          if (oldPlayAudioButton) {
              oldPlayAudioButton.addEventListener('click', () => {
                  console.log("–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ '–ü—Ä–æ—Å–ª—É—à–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–µ –∞—É–¥–∏–æ'. –î–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ –µ–µ –ª–æ–≥–∏–∫—É.");
                 
              });
          }
      });
      </script>

    {% else %}
      <div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.</div>
    {% endif %}
  </main>
</div>

{% include 'partials/loading_indicator.html' %}

{% if selected_chat %}
<script>
  window.__CHAT_CONTEXT = {
    selected_chat: {{ selected_chat|tojson }},
    // –±–µ–∑–æ–ø–∞—Å–Ω–æ: –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ—Ç ‚Äî –±—É–¥–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
    initial_messages: {{ initial_messages|default([])|tojson }}
  };
</script>
{% endif %}

{% endblock %}